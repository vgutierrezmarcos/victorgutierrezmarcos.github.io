name: Zip desde GitHub

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  create-zip:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Create materials directory
      run: |
        mkdir -p materiales-tcee
        
    - name: Copy all files
      run: |
        # Copiar todo el repositorio
        cp -r . materiales-tcee/
        
        # Eliminar archivos web del ZIP
        cd materiales-tcee
        find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.svg" -o -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.webp" -o -name "*.xml" -o -name ".gitignore" -o -name "CNAME" -o -name "*.txt" \) -delete
        
        # Eliminar carpetas git
        rm -rf .git .github
        cd ..
        
    - name: List contents
      run: |
        echo "=== Contenido del directorio materiales-tcee ==="
        ls -la materiales-tcee/
        echo ""
        echo "=== Archivos que se incluirÃ¡n en el ZIP ==="
        find materiales-tcee -type f
        
    - name: Create ZIP file
      run: |
        cd materiales-tcee
        if [ "$(find . -type f | wc -l)" -eq 0 ]; then
          echo "âš ï¸ AVISO: No hay archivos para incluir en el ZIP"
          echo "Todos los materiales estÃ¡n en Google Drive"
          # Crear un README explicativo
          echo "# Materiales TCEE" > README.md
          echo "" >> README.md
          echo "Los materiales estÃ¡n disponibles en:" >> README.md
          echo "https://drive.google.com/drive/folders/1r8qGub-oZS4xKYF-dnT_TdQ2dyAzfxB_" >> README.md
          echo "" >> README.md
          echo "O visita: https://victorgutierrezmarcos.es" >> README.md
        fi
        cd ..
        zip -r materiales-tcee.zip materiales-tcee/
        ls -lh materiales-tcee.zip
        
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        
    - name: Delete old release if exists
      continue-on-error: true
      run: |
        gh release delete materiales-latest --yes
        git push origin :refs/tags/materiales-latest
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create new release
      run: |
        gh release create materiales-latest \
          --title "Materiales TCEE (Actualizado ${{ steps.date.outputs.date }})" \
          --notes "## ğŸ“š Materiales para la OposiciÃ³n TCEE
          
          ### â„¹ï¸ InformaciÃ³n importante
          
          Los materiales principales (PDFs, documentos) estÃ¡n alojados en **Google Drive** y se acceden mediante los enlaces en la web.
          
          Este ZIP contiene la estructura del sitio web sin archivos de diseÃ±o.
          
          ### ğŸ”— Enlaces Ãºtiles
          
          - ğŸŒ **Web completa**: [victorgutierrezmarcos.es](https://victorgutierrezmarcos.es)
          - ğŸ“ **Google Drive**: [Ver materiales](https://drive.google.com/drive/folders/1r8qGub-oZS4xKYF-dnT_TdQ2dyAzfxB_)
          
          ---
          
          ğŸ“… Ãšltima actualizaciÃ³n: ${{ steps.date.outputs.date }}" \
          materiales-tcee.zip
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
