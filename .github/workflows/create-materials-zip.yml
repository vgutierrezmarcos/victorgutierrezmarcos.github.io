name: Zip desde GitHub

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  create-zip:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Create materials directory
      run: mkdir -p materiales-tcee
        
    - name: Copy files except web assets
      run: |
        # Copiar archivos individuales (no directorios) evitando materiales-tcee
        for item in *; do
          if [ "$item" != "materiales-tcee" ] && [ -f "$item" ]; then
            cp "$item" materiales-tcee/ 2>/dev/null || true
          elif [ "$item" != "materiales-tcee" ] && [ -d "$item" ]; then
            cp -r "$item" materiales-tcee/ 2>/dev/null || true
          fi
        done
        
        # TambiÃ©n copiar archivos ocultos excepto .git y .github
        for item in .[^.]*; do
          if [ "$item" != ".git" ] && [ "$item" != ".github" ] && [ -e "$item" ]; then
            cp -r "$item" materiales-tcee/ 2>/dev/null || true
          fi
        done
        
    - name: Remove web assets from materials directory
      run: |
        cd materiales-tcee
        
        # Eliminar archivos web
        find . -name "*.html" -type f -delete 2>/dev/null || true
        find . -name "*.css" -type f -delete 2>/dev/null || true
        find . -name "*.svg" -type f -delete 2>/dev/null || true
        find . -name "*.png" -type f -delete 2>/dev/null || true
        find . -name "*.jpg" -type f -delete 2>/dev/null || true
        find . -name "*.jpeg" -type f -delete 2>/dev/null || true
        find . -name "*.gif" -type f -delete 2>/dev/null || true
        find . -name "*.webp" -type f -delete 2>/dev/null || true
        find . -name "*.xml" -type f -delete 2>/dev/null || true
        find . -name "*.txt" -type f -delete 2>/dev/null || true
        find . -name ".gitignore" -type f -delete 2>/dev/null || true
        find . -name "CNAME" -type f -delete 2>/dev/null || true
        
        # Eliminar carpetas .git y .github
        rm -rf .git .github 2>/dev/null || true
        
        cd ..
        
    - name: Check contents and create README if empty
      run: |
        cd materiales-tcee
        
        # Contar archivos
        FILE_COUNT=$(find . -type f 2>/dev/null | wc -l)
        echo "ğŸ“Š Archivos encontrados: $FILE_COUNT"
        
        if [ "$FILE_COUNT" -eq 0 ]; then
          echo "âš ï¸ No hay archivos educativos en el repositorio"
          echo "ğŸ“ Creando README explicativo..."
          
          cat > README.md << 'EOF'
# Materiales TCEE - VÃ­ctor GutiÃ©rrez Marcos

## ğŸ“š Acceso a los materiales

Los materiales educativos (PDFs, documentos, plantillas) estÃ¡n alojados en **Google Drive**.

### ğŸ”— Enlaces directos:

- **Todos los materiales**: https://drive.google.com/drive/folders/1r8qGub-oZS4xKYF-dnT_TdQ2dyAzfxB_
- **Sitio web completo**: https://victorgutierrezmarcos.es

### ğŸ“– Contenido disponible:

- Temario completo (5 ejercicios)
- Recursos de organizaciÃ³n
- Plantillas de estudio
- Enlaces Ãºtiles

---

*TÃ©cnico Comercial y Economista del Estado - PromociÃ³n LXXIII*
EOF
          
          echo "âœ… README creado"
        else
          echo "âœ… Se incluirÃ¡n $FILE_COUNT archivos en el ZIP"
          echo ""
          echo "ğŸ“„ Lista de archivos:"
          find . -type f | sort
        fi
        
        cd ..
        
    - name: Create ZIP file
      run: |
        zip -r materiales-tcee.zip materiales-tcee/
        echo ""
        echo "ğŸ“¦ InformaciÃ³n del ZIP:"
        ls -lh materiales-tcee.zip
        echo ""
        echo "ğŸ“‹ Contenido del ZIP (primeros 30 elementos):"
        unzip -l materiales-tcee.zip | head -35
        
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        
    - name: Delete existing release and tag
      continue-on-error: true
      run: |
        echo "ğŸ—‘ï¸ Limpiando release anterior..."
        gh release delete materiales-latest --yes 2>/dev/null || echo "No hay release previo"
        git tag -d materiales-latest 2>/dev/null || echo "No hay tag local"
        git push origin --delete materiales-latest 2>/dev/null || echo "No hay tag remoto"
        echo "âœ… Limpieza completada"
      env:
        GH_TOKEN: ${{ github.token }}
        
    - name: Wait before creating new release
      run: sleep 3
        
    - name: Create new release
      run: |
        echo "ğŸ“¤ Creando nuevo release..."
        gh release create materiales-latest \
          materiales-tcee.zip \
          --title "Materiales TCEE - ${{ steps.date.outputs.date }}" \
          --notes "## ğŸ“š Materiales para la OposiciÃ³n TCEE
          
          **VÃ­ctor GutiÃ©rrez Marcos** - PromociÃ³n LXXIII
          
          ### â„¹ï¸ InformaciÃ³n importante
          
          Los materiales principales (PDFs, documentos de estudio) estÃ¡n alojados en **Google Drive** 
          y se acceden mediante los enlaces en el sitio web.
          
          Este ZIP contiene archivos del repositorio de GitHub (si los hay).
          
          ### ğŸ”— Acceso completo a los materiales:
          
          - ğŸŒ **Sitio web**: [victorgutierrezmarcos.es](https://victorgutierrezmarcos.es)
          - ğŸ“ **Google Drive**: [Ver todos los materiales](https://drive.google.com/drive/folders/1r8qGub-oZS4xKYF-dnT_TdQ2dyAzfxB_)
          
          ### ğŸ“– Contenido disponible:
          
          - Temario completo (Ejercicios I-V)
          - Recursos de organizaciÃ³n y planificaciÃ³n
          - Plantillas para elaborar temas
          - Enlaces Ãºtiles para la preparaciÃ³n
          
          ---
          
          ğŸ“… Actualizado: ${{ steps.date.outputs.date }}"
        
        echo "âœ… Release creado exitosamente"
      env:
        GH_TOKEN: ${{ github.token }}
